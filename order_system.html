<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¢ çƒ§çƒ¤è®¢å•è®¡ç®—å™¨ - å®æ—¶è®¢å• (Supabase åŒæ­¥)</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* CSS æ ·å¼ (ä¿æŒä¸å˜) */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 20px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); border-radius: 8px; display: flex; gap: 20px; flex-wrap: wrap; }
        .section { padding: 15px; border-radius: 6px; background-color: #fefefe; border: 1px solid #ddd; }
        h2 { color: #a04000; border-bottom: 2px solid #ff9933; padding-bottom: 5px; margin-top: 0; }
        
        /* èœå•åŒº */
        #menu-section { flex: 3; min-width: 300px; }
        #category-tabs { display: flex; overflow-x: auto; border-bottom: 1px solid #ff9933; margin-bottom: 10px; }
        .category-button { background-color: #f0f0f0; border: none; padding: 10px 15px; cursor: pointer; margin-right: 5px; border-top-left-radius: 4px; border-top-right-radius: 4px; font-weight: bold; white-space: nowrap; }
        .category-button.active { background-color: #ffaa55; color: white; border: 1px solid #ff9933; border-bottom: none; margin-bottom: -1px; }

        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .menu-item { background-color: #ffaa55; color: white; border: none; padding: 15px 10px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; text-align: center; line-height: 1.3; transition: background-color 0.2s; }
        .menu-item:hover { background-color: #ff8833; }

        /* è®¢å•åŒº - ä¿æŒä¸å˜ */
        #order-container { flex: 2; min-width: 280px; display: flex; flex-direction: column; }
        #order-tabs { display: flex; overflow-x: auto; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
        .tab-button { background-color: #e0e0e0; border: none; padding: 10px 15px; cursor: pointer; margin-right: 5px; border-top-left-radius: 4px; border-top-right-radius: 4px; font-weight: bold; white-space: nowrap; }
        .tab-button.active { background-color: #fff; border: 1px solid #ccc; border-bottom: none; margin-bottom: -1px; color: #a04000; }
        
        #order-list { list-style: none; padding: 0; margin: 15px 0; }
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 15px; }
        .item-name { flex-grow: 1; font-weight: bold; }
        .quantity-controls { display: flex; align-items: center; margin: 0 10px; }
        .qty-btn { background-color: #a04000; color: white; border: none; width: 25px; height: 25px; border-radius: 4px; cursor: pointer; font-size: 16px; line-height: 1; padding: 0; }
        .qty-btn:hover { background-color: #7a3000; }
        .item-qty { margin: 0 10px; width: 20px; text-align: center; font-weight: bold; }
        .item-subtotal { min-width: 60px; text-align: right; font-weight: bold; color: #d9534f; }
        .empty-message { text-align: center; color: #888; padding: 20px 0; }

        .total-box { text-align: right; font-size: 24px; font-weight: bold; padding: 10px 0; border-top: 2px solid #ff9933; margin-top: 15px; color: #a04000; }
        #clear-order-btn { width: 100%; padding: 10px; background-color: #d9534f; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 10px; }
        #clear-order-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .top-links a { margin-left: 10px; font-size: 14px; color: #007bff; }
    </style>
</head>
<body>

    <div class="container">
        <div id="menu-section" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>ğŸ”¥ èœå•</h2>
                <div class="top-links">
                    <a href="menu_editor.html">âš™ï¸ ç¼–è¾‘èœå•]</a>
                    <a href="history_report.html">[ğŸ“Š æŸ¥çœ‹æŠ¥å‘Š]</a>
                </div>
            </div>

            <div id="category-tabs">
                <p>æ­£åœ¨è¿æ¥æ•°æ®...</p>
            </div>

            <div id="menu-items" class="menu-grid">
                <p style="text-align: center; color: #888;">æ­£åœ¨åŠ è½½èœå•é¡¹...</p>
            </div>
        </div>

        <div id="order-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div id="order-tabs">
                </div>
            </div>
            
            <div id="order-section" class="section">
                <h2>ğŸ“ è®¢å• (<span id="current-customer-name">æ¡Œå· 1</span>)</h2>
                <ul id="order-list">
                    <li class="empty-message">æš‚æ— è®¢å•ï¼Œè¯·ä»èœå•æ·»åŠ é¡¹ç›®ã€‚</li>
                </ul>

                <div class="total-box">
                    æ€»è®¡: <span id="total-amount">0</span> Ks
                </div>
                
                <button id="clear-order-btn" class="action-btn clear-btn" disabled>æ¸…ç©ºå½“å‰è®¢å• (å·²ç»“è´¦)</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================================
        // !!! è¯·å°†æ‚¨çš„ Supabase URL å’Œ KEY ç²˜è´´åˆ°è¿™é‡Œ !!!
        // SUPABASE_URL: https://hicmcqieruonxrdmvme.supabase.co
        // SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpY2VtY3FpZXJ1b254cmRtdm1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODczODIsImV4cCI6MjA3Nzc2MzM4Mn0.TLHoQOz_eeec1YISCFogeJeM-y2_EebiJh3zikH9Jys
        // ==========================================================
        const SUPABASE_URL = "https://hicmcqieruonxrdmvme.supabase.co"; 
        const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpY2VtY3FpZXJ1b254cmRtdm1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxODczODIsImV4cCI6MjA3Nzc2MzM4Mn0.TLHoQOz_eeec1YISCFogeJeM-y2_EebiJh3zikH9Jys"; 
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // ==========================================================

        const FIXED_TABLE_COUNT = 10;
        
        // æ•°æ®å˜é‡ (ç°åœ¨è¿™äº›å˜é‡ç”± Supabase å®æ—¶åŒæ­¥)
        let menuItems = [];
        let allOrders = {};
        let currentTable = ''; 
        
        // å£°éŸ³è®¾ç½®
        const addItemSound = new Audio('add.mp3'); 
        const removeItemSound = new Audio('remove.mp3'); 
        const checkoutSound = new Audio('checkout.mp3'); 

        // DOM å…ƒç´  (ä¸å˜)
        const orderList = document.getElementById('order-list');
        const totalAmountSpan = document.getElementById('total-amount');
        const menuItemsContainer = document.getElementById('menu-items');
        const clearOrderButton = document.getElementById('clear-order-btn');
        const orderTabsContainer = document.getElementById('order-tabs');
        const currentTableNameSpan = document.getElementById('current-customer-name'); 
        const categoryTabsContainer = document.getElementById('category-tabs'); 

        let currentCategory = ''; 
        let isInitialLoad = true; 

        // --- Supabase æ•°æ®åŒæ­¥å‡½æ•° ---
        
        /**
         * 1. å¯åŠ¨è®¢å•æ•°æ®çš„å®æ—¶ç›‘å¬
         * å½“ä»»ä½•è®¾å¤‡æ›´æ”¹è®¢å•æ—¶ï¼Œæ‰€æœ‰è®¾å¤‡ç«‹å³æ›´æ–°
         */
        function subscribeToOrders() {
             // è®¢é˜… 'all_orders' è¡¨æ ¼çš„ä»»ä½•å˜åŒ– (INSERT, UPDATE, DELETE)
            supabase
                .channel('public:all_orders') 
                .on('postgres_changes', { event: '*', schema: 'public', table: 'all_orders' }, payload => {
                    console.log('è®¢å•å®æ—¶æ›´æ–°æ”¶åˆ°:', payload);
                    // æ”¶åˆ°æ›´æ–°é€šçŸ¥åï¼Œé‡æ–°ä»æ•°æ®åº“æ‹‰å–æœ€æ–°è®¢å•æ•°æ®
                    loadOrdersFromDB(true); 
                })
                .subscribe();

            // é¦–æ¬¡åŠ è½½å’Œåˆå§‹åŒ–
            loadOrdersFromDB(false);
        }

        /**
         * 2. ä» Supabase è¯»å–èœå•æ•°æ®
         */
        async function loadMenuFromDB() {
            const { data, error } = await supabase
                .from('menu_items')
                .select('id, name, price, category'); // æ˜ç¡®é€‰æ‹©éœ€è¦çš„å­—æ®µ

            if (error) {
                console.error("åŠ è½½èœå•å¤±è´¥:", error);
                menuItemsContainer.innerHTML = `<p style="color: red;">åŠ è½½èœå•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œ Supabase é…ç½®ã€‚</p>`;
                return;
            }

            menuItems = data || [];

            // é¦–æ¬¡åŠ è½½æ—¶è®¾ç½®é»˜è®¤åˆ†ç±»
            if (menuItems.length > 0 && isInitialLoad) {
                const categories = getUniqueCategories();
                currentCategory = categories[0] || '';
            }
            
            renderCategoryTabs();
            renderMenu();
        }

        /**
         * 3. ä» Supabase è¯»å–è®¢å•æ•°æ®
         */
        async function loadOrdersFromDB(isRealtimeUpdate) {
            const { data, error } = await supabase
                .from('all_orders')
                .select('table_name, order_data')
                .limit(FIXED_TABLE_COUNT);

            if (error) {
                console.error("åŠ è½½è®¢å•å¤±è´¥:", error);
                return;
            }

            // å°† Supabase è¿”å›çš„æ•°ç»„è½¬æ¢ä¸ºæˆ‘ä»¬éœ€è¦çš„ { "æ¡Œå· 1": {...}, ... } ç»“æ„
            let newAllOrders = {};
            data.forEach(row => {
                newAllOrders[row.table_name] = row.order_data || {};
            });
            
            // åˆå§‹åŒ–æˆ–åˆå¹¶ 10 ä¸ªæ¡Œå·ï¼ˆå¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œåˆ™åˆ›å»ºç©ºè®¢å•ï¼‰
            let shouldUpdateDB = false;
            for (let i = 1; i <= FIXED_TABLE_COUNT; i++) {
                const tableName = `æ¡Œå· ${i}`;
                if (!newAllOrders.hasOwnProperty(tableName)) {
                    newAllOrders[tableName] = {};
                    shouldUpdateDB = true;
                }
            }

            allOrders = newAllOrders;
            
            // é¦–æ¬¡åŠ è½½æ—¶è®¾ç½®å½“å‰æ¡Œå·
            if (!isRealtimeUpdate && !currentTable) {
                 const allTableKeys = Object.keys(allOrders).sort((a, b) => {
                    const numA = parseInt(a.replace('æ¡Œå· ', ''));
                    const numB = parseInt(b.replace('æ¡Œå· ', ''));
                    return numA - numB;
                });
                currentTable = allTableKeys[0] || `æ¡Œå· 1`;
                isInitialLoad = false;
            }

            // å¦‚æœå‘ç°æœ‰æ¡Œå·ç¼ºå¤±ï¼Œåˆ™å°†å…¶å†™å…¥æ•°æ®åº“ï¼ˆé¿å…å¾ªç¯ï¼Œåªå†™å…¥ç¼ºå¤±çš„éƒ¨åˆ†ï¼‰
            if (shouldUpdateDB) {
                const tablesToUpsert = [];
                 for (let i = 1; i <= FIXED_TABLE_COUNT; i++) {
                    const tableName = `æ¡Œå· ${i}`;
                    tablesToUpsert.push({
                         table_name: tableName,
                         order_data: allOrders[tableName] || {}
                    });
                }
                saveAllOrdersToDB(tablesToUpsert); 
            }

            renderOrderTabs();
            renderOrder();
        }


        /**
         * 4. ä¿å­˜å•ä¸ªæ¡Œå·çš„è®¢å•åˆ° Supabase (å…³é”®ä¿å­˜é€»è¾‘)
         */
        async function saveOrderToDB(tableName) {
            const orderToSave = {
                table_name: tableName, 
                order_data: allOrders[tableName] || {} 
            };
            
            // ä½¿ç”¨ upsert æ’å…¥æˆ–æ›´æ–°ï¼Œtable_name å¿…é¡»æ˜¯å”¯ä¸€çš„ (Primary Key)
            const { error } = await supabase
                .from('all_orders')
                .upsert(orderToSave, { onConflict: 'table_name' });

            if (error) {
                console.error("è®¢å•ä¿å­˜å¤±è´¥:", error);
                alert("è®¢å•ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œï¼");
            }
        }

        /**
         * 5. æ‰¹é‡ä¿å­˜æ‰€æœ‰æ¡Œå·ï¼ˆç”¨äºåˆå§‹åŒ–ç¼ºå¤±æ•°æ®ï¼‰
         */
        async function saveAllOrdersToDB(dataToUpsert) {
            const { error } = await supabase
                .from('all_orders')
                .upsert(dataToUpsert, { onConflict: 'table_name' });

            if (error) {
                console.error("åˆå§‹åŒ–æ‰€æœ‰è®¢å•å¤±è´¥:", error);
            }
        }

        /**
         * 6. ä¿å­˜å†å²è®°å½•åˆ° Supabase
         */
        async function saveHistoryToDB(historyEntry) {
             const { error } = await supabase
                .from('history_records')
                .insert([historyEntry]);

            if (error) {
                console.error("å†å²è®°å½•ä¿å­˜å¤±è´¥:", error);
            }
        }


        // --- æ ¸å¿ƒè®¢å•æ“ä½œå‡½æ•° (ä¿®æ”¹ä¸ºè°ƒç”¨ Supabase ä¿å­˜) ---

        function addItemToOrder(itemId) {
            const itemData = menuItems.find(item => item.id === itemId);
            if (!itemData) return;
            const order = allOrders[currentTable];
            // ç¡®ä¿ä¿å­˜åˆ°è®¢å•çš„æ•°æ®åŒ…å« name, price, category
            const itemToSave = { 
                id: itemData.id, 
                name: itemData.name, 
                price: itemData.price, 
                category: itemData.category 
            };

            order[itemId] = order[itemId] ? {...order[itemId], quantity: order[itemId].quantity + 1} : { itemData: itemToSave, quantity: 1 };
            
            // è°ƒç”¨ Supabase ä¿å­˜
            saveOrderToDB(currentTable); 

            // å£°éŸ³åé¦ˆ
            addItemSound.play().catch(e => console.log('æ— æ³•æ’­æ”¾æ·»åŠ å£°éŸ³:', e)); 
        }

        function decreaseItemQuantity(itemId) {
            const order = allOrders[currentTable];
            if (order[itemId]) {
                order[itemId].quantity -= 1;
                const isRemoved = order[itemId].quantity <= 0;
                if (isRemoved) {
                    delete order[itemId];
                }

                // è°ƒç”¨ Supabase ä¿å­˜
                saveOrderToDB(currentTable); 
                
                // å£°éŸ³åé¦ˆ
                removeItemSound.play().catch(e => console.log('æ— æ³•æ’­æ”¾ç§»é™¤å£°éŸ³:', e));
            }
        }

        function clearOrder() {
            const orderData = allOrders[currentTable];
            if (Object.keys(orderData).length > 0) {
                const total = calculateTotal(); 
                
                // 1. åˆ›å»ºå†å²è®°å½•å¯¹è±¡
                const historyEntry = {
                    customer: currentTable, 
                    total_amount: total,
                    items: JSON.parse(JSON.stringify(orderData)), 
                    // Supabase æ¨èä½¿ç”¨ ISO æ ¼å¼
                    timestamp: new Date().toISOString(), 
                };

                // 2. ä¿å­˜å†å²è®°å½•åˆ° Supabase
                saveHistoryToDB(historyEntry);

                alert(`å·²å®Œæˆ ${currentTable} çš„è®¢å•ï¼Œæ€»é‡‘é¢: ${total.toFixed(0)} Ksã€‚è®¢å•å·²è®°å½•ã€‚`);
                checkoutSound.play().catch(e => console.log('æ— æ³•æ’­æ”¾ç»“è´¦å£°éŸ³:', e));
            }
            
            // 3. æ¸…ç©ºè®¢å•å¹¶ä¿å­˜åˆ° Supabase
            allOrders[currentTable] = {};
            saveOrderToDB(currentTable);
            // ç•Œé¢åˆ·æ–°ç”±å®æ—¶ç›‘å¬è§¦å‘
        }

        // --- èœå•å’Œè®¢å•æ¸²æŸ“/é€»è¾‘å‡½æ•° (ä¿æŒä¸å˜) ---

        function calculateTotal() {
            const order = allOrders[currentTable] || {};
            let total = 0;
            for (const itemId in order) {
                const item = order[itemId];
                // ä½¿ç”¨è®¢å•ä¸­ç¼“å­˜çš„ price è®¡ç®—ï¼Œæˆ–è€…å¦‚æœèœå•åŠ è½½äº†åˆ™ä½¿ç”¨æœ€æ–°çš„ price
                const currentItemData = menuItems.find(m => m.id === item.itemData.id);
                const price = currentItemData ? currentItemData.price : item.itemData.price;
                total += price * item.quantity;
            }
            totalAmountSpan.textContent = total.toFixed(0);
            clearOrderButton.disabled = total === 0;
            return total;
        }

        function switchCategory(categoryName) {
            currentCategory = categoryName;
            renderCategoryTabs();
            renderMenu();
        }
        
        function getUniqueCategories() {
            return [...new Set(menuItems.map(item => item.category || 'æœªåˆ†ç±»'))].sort();
        }

        function renderCategoryTabs() {
            categoryTabsContainer.innerHTML = '';
            const categories = getUniqueCategories();

            if (categories.length === 0) {
                 categoryTabsContainer.innerHTML = `<p style="color:#d9534f; padding: 10px 0;">èœå•ä¸ºç©ºï¼Œè¯·å…ˆåœ¨ [ç¼–è¾‘èœå•] ä¸­æ·»åŠ åˆ†ç±»ã€‚</p>`;
                 return;
            }

            categories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-button';
                button.textContent = category;
                
                if (category === currentCategory) {
                    button.classList.add('active');
                }
                
                button.addEventListener('click', () => switchCategory(category));
                categoryTabsContainer.appendChild(button);
            });
        }
        
        function renderMenu() {
            menuItemsContainer.innerHTML = '';
            
            if (menuItems.length === 0 || !currentCategory) {
                 const message = menuItems.length === 0 ? "èœå•ä¸ºç©ºï¼è¯·ç‚¹å‡» [ç¼–è¾‘èœå•] æ·»åŠ é¡¹ç›®ã€‚" : "è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ã€‚";
                 menuItemsContainer.innerHTML = `<p style="text-align: center; color: #888;">${message}</p>`;
                 return;
            }

            const itemsToDisplay = menuItems.filter(item => (item.category || 'æœªåˆ†ç±»') === currentCategory);

            if (itemsToDisplay.length === 0) {
                 menuItemsContainer.innerHTML = `<p style="text-align: center; color: #888;">å½“å‰åˆ†ç±»ä¸‹æš‚æ— èœå•é¡¹ã€‚</p>`;
                 return;
            }

            itemsToDisplay.forEach(item => {
                const button = document.createElement('button');
                button.className = 'menu-item';
                button.dataset.id = item.id;
                button.innerHTML = `${item.name} <br> (${item.price.toFixed(0)} Ks)`;
                button.addEventListener('click', () => addItemToOrder(item.id));
                menuItemsContainer.appendChild(button);
            });
        }

        function renderOrder() {
            const order = allOrders[currentTable] || {};
            orderList.innerHTML = ''; 
            currentTableNameSpan.textContent = currentTable; 

            const itemIds = Object.keys(order);
            
            if (itemIds.length === 0) {
                orderList.innerHTML = `<li class="empty-message">æš‚æ— è®¢å•ï¼Œè¯·ä»èœå•æ·»åŠ é¡¹ç›®ã€‚</li>`;
            } else {
                itemIds.forEach(itemId => {
                    const item = order[itemId];
                    const li = document.createElement('li');
                    li.className = 'order-item';
                    
                    const currentItemData = menuItems.find(m => m.id === item.itemData.id);
                    const price = currentItemData ? currentItemData.price : item.itemData.price;
                    const subtotal = price * item.quantity;

                    li.innerHTML = `
                        <span class="item-name">${item.itemData.name}</span>
                        <span class="item-price">(${price.toFixed(0)} Ks/ä»½)</span>
                        <div class="quantity-controls">
                            <button data-id="${itemId}" class="qty-btn minus-btn">-</button>
                            <span class="item-qty">${item.quantity}</span>
                            <button data-id="${itemId}" class="qty-btn plus-btn">+</button>
                        </div>
                        <span class="item-subtotal">${subtotal.toFixed(0)} Ks</span>
                    `;
                    orderList.appendChild(li);
                });
                
                document.querySelectorAll('.qty-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id); 
                        if (e.currentTarget.classList.contains('plus-btn')) {
                            addItemToOrder(id);
                        } else if (e.currentTarget.classList.contains('minus-btn')) {
                            decreaseItemQuantity(id);
                        }
                    });
                });
            }
            calculateTotal(); 
        }

        function switchTable(tableName) {
            currentTable = tableName;
            renderOrderTabs();
            renderOrder();
        }

        function renderOrderTabs() {
            orderTabsContainer.innerHTML = '';
            
            for (let i = 1; i <= FIXED_TABLE_COUNT; i++) {
                const tableName = `æ¡Œå· ${i}`;
                const button = document.createElement('button');
                button.className = 'tab-button';
                
                const hasOrder = allOrders[tableName] && Object.keys(allOrders[tableName]).length > 0;

                if (tableName === currentTable) {
                    button.classList.add('active');
                }
                
                button.textContent = hasOrder ? `${tableName} *` : tableName;
                
                button.addEventListener('click', () => switchTable(tableName));
                orderTabsContainer.appendChild(button);
            }
        }
        
        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½èœå• (ä¸éœ€è¦å®æ—¶åŒæ­¥)
            loadMenuFromDB(); 
            // è®¢é˜…è®¢å• (å®æ—¶åŒæ­¥)
            subscribeToOrders(); 
            
            clearOrderButton.addEventListener('click', clearOrder);
        });
    </script>
</body>
</html>